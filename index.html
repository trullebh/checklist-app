import React, { useState, useEffect } from 'react';
import { Users, LogOut, RefreshCw, Trash2, Activity } from 'lucide-react';

const StrapCollaborative = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [syncing, setSyncing] = useState(false);
  const [activePane, setActivePane] = useState('dashboard');
  const [projects, setProjects] = useState({});
  const [categories] = useState(['Geral', 'Estrutural']);
  const [currentProject, setCurrentProject] = useState(null);
  const [activityLog, setActivityLog] = useState([]);
  const [lastSync, setLastSync] = useState(null);

  const defaultSections = {
    "Prepara√ß√£o do Modelo": ["Definir o unifilar", "Lan√ßar os tipos de perfis", "Corrigir a orienta√ß√£o dos perfis"],
    "Determinar Vistas": ["Vista 3D", "Eixos", "Filas", "Eleva√ß√µes"],
    "Condi√ß√µes de Contorno": ["Aplicar apoios", "Liga√ß√µes r√≠gidas"],
    "Carregamentos": ["Lan√ßar carregamentos", "Configurar padr√µes", "Definir combina√ß√µes"],
    "Verifica√ß√µes": ["Verifica√ß√£o da deformada", "Verifica√ß√£o dos diagramas", "Combinar barras cont√≠nuas"],
    "Dimensionamento": ["Dimensionar estrutura e atualizar geometria"]
  };

  useEffect(() => {
    initializeApp();
  }, []);

  useEffect(() => {
    if (user) {
      const interval = setInterval(() => syncData(), 30000);
      return () => clearInterval(interval);
    }
  }, [user, projects, activityLog]);

  const initializeApp = async () => {
    setLoading(true);
    try {
      const savedUser = localStorage.getItem('strap_user');
      if (savedUser) {
        setUser(JSON.parse(savedUser));
        await loadDataFromStorage();
      }
    } catch (error) {
      console.error('Erro:', error);
    }
    setLoading(false);
  };

  const loadDataFromStorage = async () => {
    setSyncing(true);
    try {
      const projectsData = await window.storage.get('strap_projects', true);
      if (projectsData) setProjects(JSON.parse(projectsData.value));

      const logData = await window.storage.get('strap_activity_log', true);
      if (logData) setActivityLog(JSON.parse(logData.value));

      setLastSync(new Date());
    } catch (error) {
      console.error('Erro ao carregar:', error);
    }
    setSyncing(false);
  };

  const syncData = async () => {
    if (!user) return;
    setSyncing(true);
    try {
      await window.storage.set('strap_projects', JSON.stringify(projects), true);
      await window.storage.set('strap_activity_log', JSON.stringify(activityLog), true);
      setLastSync(new Date());
    } catch (error) {
      console.error('Erro ao sincronizar:', error);
    }
    setSyncing(false);
  };

  const logActivity = (action, details) => {
    const entry = {
      id: Date.now(),
      user: user.email,
      action,
      details,
      timestamp: new Date().toISOString()
    };
    setActivityLog([entry, ...activityLog].slice(0, 100));
  };

  const login = async (email, password) => {
    if (email && password.length >= 6) {
      const userData = { email, name: email.split('@')[0] };
      setUser(userData);
      localStorage.setItem('strap_user', JSON.stringify(userData));
      await loadDataFromStorage();
      logActivity('login', 'Usu√°rio conectado');
      return true;
    }
    return false;
  };

  const logout = () => {
    setUser(null);
    localStorage.removeItem('strap_user');
    setActivePane('dashboard');
  };

  const createProject = async (name, category) => {
    if (!name || projects[name]) return false;
    
    const newProject = {
      meta: { category, created: new Date().toISOString(), createdBy: user.email },
      tasks: {},
      customSections: {}
    };

    Object.entries(defaultSections).forEach(([section, tasks]) => {
      tasks.forEach(task => {
        newProject.tasks[`${section}::${task}`] = false;
      });
    });

    setProjects({ ...projects, [name]: newProject });
    logActivity('create_project', `Projeto "${name}" criado`);
    await syncData();
    return true;
  };

  const toggleTask = async (projectName, taskId, value) => {
    const project = projects[projectName];
    if (!project) return;

    const updatedTasks = { ...project.tasks, [taskId]: value };
    const updated = { ...project, tasks: updatedTasks };
    
    setProjects({ ...projects, [projectName]: updated });
    
    const taskName = taskId.split('::')[1];
    logActivity('toggle_task', `"${taskName}" ${value ? 'conclu√≠da' : 'desmarcada'} em "${projectName}"`);
    await syncData();
  };

  const deleteProject = async (projectName) => {
    const newProjects = { ...projects };
    delete newProjects[projectName];
    setProjects(newProjects);
    logActivity('delete_project', `Projeto "${projectName}" exclu√≠do`);
    await syncData();
  };

  if (!user) {
    return <LoginScreen onLogin={login} loading={loading} />;
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="flex">
        <Sidebar 
          user={user}
          activePane={activePane}
          setActivePane={setActivePane}
          currentProject={currentProject}
          syncing={syncing}
          lastSync={lastSync}
          syncData={syncData}
          logout={logout}
          categories={categories}
          onCreateProject={createProject}
        />

        <main className="flex-1 p-8 overflow-auto">
          {activePane === 'dashboard' && (
            <Dashboard 
              projects={projects} 
              onOpenProject={(name) => {
                setCurrentProject(name);
                setActivePane('checklist');
              }} 
            />
          )}
          
          {activePane === 'projects' && (
            <ProjectsList 
              projects={projects}
              onOpenProject={(name) => {
                setCurrentProject(name);
                setActivePane('checklist');
              }}
              onDeleteProject={deleteProject}
            />
          )}
          
          {activePane === 'checklist' && currentProject && (
            <ChecklistView
              projectName={currentProject}
              project={projects[currentProject]}
              defaultSections={defaultSections}
              onToggleTask={toggleTask}
              onDeleteProject={() => {
                deleteProject(currentProject);
                setCurrentProject(null);
                setActivePane('dashboard');
              }}
            />
          )}
          
          {activePane === 'activity' && <ActivityLog activityLog={activityLog} />}
        </main>
      </div>
    </div>
  );
};

const LoginScreen = ({ onLogin, loading }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = async () => {
    setError('');
    if (!email || !password) {
      setError('Preencha todos os campos');
      return;
    }
    const success = await onLogin(email, password);
    if (!success) setError('Email ou senha inv√°lidos (m√≠nimo 6 caracteres)');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
        <div className="text-center mb-8">
          <div className="w-24 h-24 bg-gradient-to-br from-blue-600 to-purple-600 rounded-3xl mx-auto mb-6 flex items-center justify-center text-white text-4xl font-bold">S</div>
          <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Checklist STRAP</h1>
          <p className="text-gray-600">Sistema Colaborativo</p>
        </div>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="seu@email.com"
            />
          </div>
          
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Senha</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
          
          {error && (
            <div className="bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm font-medium">
              {error}
            </div>
          )}
          
          <button
            onClick={handleSubmit}
            disabled={loading}
            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold hover:shadow-xl transition-all disabled:opacity-50"
          >
            {loading ? 'Carregando...' : 'Entrar'}
          </button>
          
          <p className="text-xs text-center text-gray-500 mt-4">Use qualquer email e senha com 6+ caracteres</p>
        </div>

        <div className="mt-8 grid grid-cols-3 gap-4 text-center">
          <div className="p-3 bg-blue-50 rounded-xl">
            <div className="text-2xl mb-1">üîÑ</div>
            <p className="text-xs text-gray-600">Sync real-time</p>
          </div>
          <div className="p-3 bg-purple-50 rounded-xl">
            <div className="text-2xl mb-1">üë•</div>
            <p className="text-xs text-gray-600">Multi-usu√°rio</p>
          </div>
          <div className="p-3 bg-green-50 rounded-xl">
            <div className="text-2xl mb-1">üìù</div>
            <p className="text-xs text-gray-600">Hist√≥rico</p>
          </div>
        </div>
      </div>
    </div>
  );
};

const Sidebar = ({ user, activePane, setActivePane, currentProject, syncing, lastSync, syncData, logout, categories, onCreateProject }) => {
  const [name, setName] = useState('');
  const [category, setCategory] = useState(categories[0]);

  const handleCreate = async () => {
    if (!name.trim()) {
      alert('Digite um nome para o projeto');
      return;
    }
    const success = await onCreateProject(name, category);
    if (success) {
      setName('');
      alert('Projeto criado com sucesso!');
    } else {
      alert('J√° existe um projeto com esse nome');
    }
  };

  return (
    <aside className="w-80 bg-white border-r border-gray-200 p-6 min-h-screen">
      <div className="mb-8">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-14 h-14 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl">S</div>
          <div>
            <h2 className="font-bold text-xl">STRAP</h2>
            <p className="text-xs text-gray-500">Colaborativo</p>
          </div>
        </div>
        
        <div className="flex items-center gap-3 p-4 rounded-xl bg-gradient-to-r from-blue-50 to-purple-50">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
            {user.name[0].toUpperCase()}
          </div>
          <div className="flex-1">
            <p className="text-sm font-bold">{user.name}</p>
            <p className="text-xs text-gray-500">{user.email}</p>
          </div>
          <button onClick={logout} className="p-2 hover:bg-red-100 rounded-lg" title="Sair">
            <LogOut className="w-4 h-4 text-red-600" />
          </button>
        </div>
      </div>

      <div className="space-y-2 mb-8">
        <NavButton active={activePane === 'dashboard'} onClick={() => setActivePane('dashboard')}>üìä Dashboard</NavButton>
        <NavButton active={activePane === 'projects'} onClick={() => setActivePane('projects')}>üìÅ Projetos</NavButton>
        {currentProject && (
          <NavButton active={activePane === 'checklist'} onClick={() => setActivePane('checklist')}>
            ‚úÖ {currentProject.substring(0, 15)}...
          </NavButton>
        )}
        <NavButton active={activePane === 'activity'} onClick={() => setActivePane('activity')}>
          <Activity className="w-4 h-4 inline mr-2" />Atividades
        </NavButton>
      </div>

      <div className="p-4 rounded-xl bg-gray-100 mb-6">
        <div className="flex items-center justify-between mb-3">
          <span className="text-sm font-semibold">Sincroniza√ß√£o</span>
          <button onClick={syncData} disabled={syncing} className="p-2 hover:bg-blue-100 rounded-lg">
            <RefreshCw className={`w-4 h-4 text-blue-600 ${syncing ? 'animate-spin' : ''}`} />
          </button>
        </div>
        {lastSync && <p className="text-xs text-gray-500">√öltima: {lastSync.toLocaleTimeString('pt-BR')}</p>}
        <div className={`mt-2 px-2 py-1 rounded-lg text-xs ${syncing ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
          {syncing ? 'üîÑ Sincronizando...' : '‚úì Sincronizado'}
        </div>
      </div>

      <div className="p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200">
        <p className="text-sm font-bold mb-4">‚ûï Criar Novo Projeto</p>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="Nome do projeto"
          className="w-full px-3 py-2 rounded-lg mb-3 bg-white border-2 border-gray-300 focus:ring-2 focus:ring-green-500"
        />
        <select
          value={category}
          onChange={(e) => setCategory(e.target.value)}
          className="w-full px-3 py-2 rounded-lg mb-3 bg-white border-2 border-gray-300 focus:ring-2 focus:ring-green-500"
        >
          {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
        </select>
        <button onClick={handleCreate} className="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2.5 rounded-lg font-bold hover:shadow-lg">
          Criar
        </button>
      </div>
    </aside>
  );
};

const NavButton = ({ active, onClick, children }) => (
  <button onClick={onClick} className={`w-full text-left px-4 py-3 rounded-xl font-semibold transition-all ${active ? 'bg-gradient-to-r from-blue-100 to-purple-100 text-blue-700 shadow-md' : 'hover:bg-gray-100 text-gray-700'}`}>
    {children}
  </button>
);

const Dashboard = ({ projects, onOpenProject }) => {
  const projectList = Object.entries(projects);
  const totalProjects = projectList.length;
  const avgProgress = totalProjects > 0 ? Math.round(projectList.reduce((sum, [_, p]) => {
    const tasks = Object.values(p.tasks || {});
    return sum + (tasks.filter(t => t).length / (tasks.length || 1)) * 100;
  }, 0) / totalProjects) : 0;

  return (
    <div>
      <h1 className="text-4xl font-bold mb-8 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Dashboard</h1>
      
      <div className="grid grid-cols-3 gap-6 mb-8">
        <div className="bg-white rounded-2xl p-6 shadow-xl border-2 border-blue-100">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-2xl">üìÅ</div>
            <h3 className="text-sm text-gray-500 font-semibold">Projetos</h3>
          </div>
          <p className="text-5xl font-bold text-blue-600">{totalProjects}</p>
        </div>
        
        <div className="bg-white rounded-2xl p-6 shadow-xl border-2 border-emerald-100">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center text-2xl">üìä</div>
            <h3 className="text-sm text-gray-500 font-semibold">Progresso</h3>
          </div>
          <p className="text-5xl font-bold text-emerald-600">{avgProgress}%</p>
        </div>
        
        <div className="bg-white rounded-2xl p-6 shadow-xl border-2 border-purple-100">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center text-2xl">‚úì</div>
            <h3 className="text-sm text-gray-500 font-semibold">Tarefas</h3>
          </div>
          <p className="text-5xl font-bold text-purple-600">
            {projectList.reduce((sum, [_, p]) => sum + Object.values(p.tasks || {}).filter(t => t).length, 0)}
          </p>
        </div>
      </div>

      <div className="bg-white rounded-2xl p-6 shadow-xl border-2 border-gray-100">
        <h2 className="text-2xl font-bold mb-6">Projetos Recentes</h2>
        <div className="space-y-4">
          {projectList.length === 0 ? (
            <p className="text-center text-gray-500 py-8">Nenhum projeto ainda. Crie seu primeiro!</p>
          ) : (
            projectList.sort((a, b) => new Date(b[1].meta.created) - new Date(a[1].meta.created)).slice(0, 5).map(([name, project]) => {
              const progress = Math.round((Object.values(project.tasks).filter(t => t).length / Object.values(project.tasks).length) * 100) || 0;
              return (
                <div key={name} className="flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-gray-50 to-blue-50 border-2 border-gray-200 hover:shadow-lg transition-all">
                  <div className="flex-1">
                    <h3 className="font-bold text-lg">{name}</h3>
                    <p className="text-sm text-gray-500 mt-1">{project.meta.category} ‚Ä¢ {progress}%</p>
                    <div className="w-64 h-2 bg-gray-200 rounded-full overflow-hidden mt-2">
                      <div className="h-full bg-gradient-to-r from-emerald-500 to-green-500" style={{ width: `${progress}%` }} />
                    </div>
                    <p className="text-xs text-gray-400 mt-2">Por {project.meta.createdBy}</p>
                  </div>
                  <button onClick={() => onOpenProject(name)} className="ml-4 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:shadow-lg font-bold">
                    Abrir
                  </button>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
};

const ProjectsList = ({ projects, onOpenProject, onDeleteProject }) => {
  const [filter, setFilter] = useState('');
  const projectList = Object.entries(projects).filter(([name]) => name.toLowerCase().includes(filter.toLowerCase()));

  return (
    <div>
      <div className="flex items-center justify-between mb-8">
        <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Projetos</h1>
        <input type="text" value={filter} onChange={(e) => setFilter(e.target.value)} placeholder="üîç Buscar..." className="px-4 py-3 rounded-xl bg-white border-2 border-gray-300 focus:ring-2 focus:ring-blue-500 w-80" />
      </div>

      <div className="space-y-4">
        {projectList.length === 0 ? (
          <p className="text-center text-gray-500 py-16">Nenhum projeto encontrado</p>
        ) : (
          projectList.map(([name, project]) => {
            const progress = Math.round((Object.values(project.tasks).filter(t => t).length / Object.values(project.tasks).length) * 100) || 0;
            return (
              <div key={name} className="flex items-center justify-between p-6 rounded-2xl bg-white shadow-xl border-2 border-gray-100 hover:shadow-2xl transition-all">
                <div className="flex-1">
                  <h3 className="text-2xl font-bold">{name}</h3>
                  <p className="text-sm text-gray-500 mt-2">{project.meta.category}</p>
                  <div className="mt-3">
                    <div className="w-96 h-3 bg-gray-200 rounded-full overflow-hidden">
                      <div className="h-full bg-gradient-to-r from-emerald-500 to-green-500" style={{ width: `${progress}%` }} />
                    </div>
                    <p className="text-xs text-gray-500 mt-1">{progress}% conclu√≠do</p>
                  </div>
                  <p className="text-xs text-gray-400 mt-3">Criado por {project.meta.createdBy} ‚Ä¢ {new Date(project.meta.created).toLocaleDateString('pt-BR')}</p>
                </div>
                <div className="flex gap-3">
                  <button onClick={() => onOpenProject(name)} className="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:shadow-lg font-bold">
                    Abrir
                  </button>
                  <button onClick={() => confirm(`Excluir "${name}"?`) && onDeleteProject(name)} className="px-4 py-3 bg-red-600 text-white rounded-xl hover:shadow-lg">
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
};

const ChecklistView = ({ projectName, project, defaultSections, onToggleTask, onDeleteProject }) => {
  const sections = { ...defaultSections, ...project.customSections };
  const progress = Math.round((Object.values(project.tasks).filter(t => t).length / Object.values(project.tasks).length) * 100) || 0;

  return (
    <div>
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-3xl font-bold">{projectName}</h1>
          <p className="text-sm text-gray-500 mt-1">{project.meta.category} ‚Ä¢ Por {project.meta.createdBy}</p>
        </div>
        <button onClick={() => confirm(`Excluir "${projectName}"?`) && onDeleteProject()} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
          Excluir
        </button>
      </div>

      <div className="bg-white rounded-xl p-6 shadow-lg mb-6">
        <div className="flex items-center justify-between mb-2">
          <h3 className="font-semibold">Progresso</h3>
          <span className="text-2xl font-bold text-emerald-600">{progress}%</span>
        </div>
        <div className="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
          <div className="h-full bg-emerald-500 transition-all" style={{ width: `${progress}%` }} />
        </div>
      </div>

      <div className="space-y-6">
        {Object.entries(sections).map(([section, tasks]) => (
          <div key={section} className="bg-white rounded-xl p-6 shadow-lg">
            <h3 className="text-lg font-bold mb-4">{section}</h3>
            <div className="space-y-2">
              {tasks.map(task => {
                const taskId = `${section}::${task}`;
                const checked = project.tasks[taskId] || false;
                return (
                  <div key={taskId} className="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                    <input
                      type="checkbox"
                      checked={checked}
                      onChange={(e) => onToggleTask(projectName, taskId, e.target.checked)}
                      className="w-5 h-5 text-blue-600 rounded"
                    />
                    <span className={`flex-1 ${checked ? 'line-through text-gray-400' : ''}`}>{task}</span>
                  </div>
                );
              })}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const ActivityLog = ({ activityLog }) => {
  return (
    <div>
      <h1 className="text-4xl font-bold mb-8 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Atividades</h1>
      
      <div className="bg-white rounded-xl p-6 shadow-lg">
        <div className="space-y-3">
          {activityLog.length === 0 ? (
            <p className="text-gray-500 text-center py-8">Nenhuma atividade registrada</p>
          ) : (
            activityLog.map(entry => (
              <div key={entry.id} className="p-4 rounded-lg bg-gray-50">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <p className="font-semibold text-sm">{entry.user}</p>
                    <p className="text-gray-600 mt-1">{entry.details}</p>
                  </div>
                  <span className="text-xs text-gray-500">{new Date(entry.timestamp).toLocaleString('pt-BR')}</span>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

export default StrapCollaborative;